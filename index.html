<<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Equipment Search</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        body {
            font-family: Arial, sans-serif;
        }

        .search-container, .upload-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: 50px;
        }

        .search-container input {
            margin: 10px;
            padding: 10px;
            width: 80%;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        .result {
            margin: 10px;
            padding: 10px;
            width: 80%;
            border: 1px solid #ccc;
            border-radius: 4px;
            background-color: #f9f9f9;
        }

        .result table {
            width: 100%;
            border-collapse: collapse;
            table-layout: auto;
        }

        .result th, .result td {
            border: 1px solid #ccc;
            padding: 8px;
            text-align: left;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .result th {
            background-color: #f2f2f2;
        }

        #resultTable {
            width: 100%;
        }

        #resultTable th,
        #resultTable td {
            white-space: nowrap;
        }

        #resultTable th:nth-child(8),
        #resultTable td:nth-child(8) {
            min-width: 70px;
            max-width: 150px;
        }

        #resultTable th:nth-child(9),
        #resultTable td:nth-child(9) {
            min-width: 300px;
            max-width: 600px;
        }
    </style>
</head>
<body>
    <div class="search-container">
        <input type="text" id="serialNumber" placeholder="Search by Serial Number" onkeyup="searchEquipment()">
        <input type="text" id="office" placeholder="Search by Office" onkeyup="searchEquipment()">
        <input type="text" id="modality" placeholder="Search by Modality" onkeyup="searchEquipment()">
        <input type="text" id="make" placeholder="Search by Make" onkeyup="searchEquipment()">
    </div>
    
    <div class="upload-container">
        <h1>Upload Data</h1>
        <input type="file" id="fileInput">
        <button onclick="readFile()">Upload</button>
        <pre id="output"></pre>
    </div>

    <table id="resultTable" class="result">
        <thead>
            <tr>
                <th>Serial Number</th>
                <th>UP#</th>
                <th>Make</th>
                <th>Office</th>
                <th>Modality</th>
                <th>Status</th>
                <th>Room</th>
                <th>Tech</th>
                <th>Equipment</th>
                <th>Contract/Warranty Begin</th>
                <th>Contract/Warranty End Date</th>
                <th>Service Support</th>
                <th>Support Phone#</th>
                <th>Support Email</th>
                <th>Coverage Days left</th>
                <th>Service Annual Fee</th>
                <th>Note</th>
                <th>Purchase From</th>
                <th>Purchase Date</th>
                <th>Delivery Date</th>
                <th>Install Date</th>
                <th>Remove By</th>
                <th>Remove Date</th>
                <th>Remove Description</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <script>
        let equipmentData = [];

        // Load data from local storage on page load
        document.addEventListener('DOMContentLoaded', () => {
            const storedData = localStorage.getItem('equipmentData');
            if (storedData) {
                equipmentData = JSON.parse(storedData);
                displayResults(equipmentData);
            }
        });

        function readFile() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            
            console.log('File selected:', file);

            if (file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    const csvData = event.target.result;
                    console.log('CSV Data:', csvData);

                    const newData = parseCSV(csvData);
                    console.log('Parsed Data:', newData);

                    equipmentData = [...equipmentData, ...newData];
                    console.log('Updated Equipment Data:', equipmentData);

                    localStorage.setItem('equipmentData', JSON.stringify(equipmentData));

                    displayResults(equipmentData);
                };
                reader.onerror = function(event) {
                    console.error('File read error:', event);
                };
                reader.readAsText(file);
            } else {
                alert('Please select a file.');
            }
        }

        function parseCSV(data) {
            const lines = data.split('\n');
            const headers = lines[0].split(',').map(header => header.trim());
            const result = [];

            console.log('CSV Headers:', headers);

            for (let i = 1; i < lines.length; i++) {
                const currentLine = lines[i].split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
                console.log(`Processing line ${i}:`, currentLine);

                if (currentLine.every(cell => cell.trim() === '')) {
                    console.warn(`Skipping line ${i} because it's empty.`);
                    continue;
                }

                const obj = {};
                for (let j = 0; j < headers.length; j++) {
                    let cellValue = currentLine[j] ? currentLine[j].trim() : '';

                    if (headers[j] === 'Service Annual Fee') {
                        cellValue = cellValue.replace(/[^0-9.,]/g, '');
                        cellValue = `$${cellValue}`;
                    }

                    cellValue = cellValue.replace(/[^ -~]/g, '');

                    if (cellValue.startsWith('"') && cellValue.endsWith('"')) {
                        cellValue = cellValue.slice(1, -1);
                    }

                    obj[headers[j]] = cellValue;

                    console.log(`Header: ${headers[j]}, Value: ${cellValue}`);
                }
                result.push(obj);
            }

            console.log('Parsed CSV Result:', result);
            return result;
        }

        function displayResults(data) {
            const resultTable = document.getElementById('resultTable').getElementsByTagName('tbody')[0];

            resultTable.innerHTML = '';

            data.forEach((item, index) => {
                const row = resultTable.insertRow();
                Object.entries(item).forEach(([key, val]) => {
                    if (key !== 'contractFile') {
                        const cell = row.insertCell();
                        cell.textContent = val;
                        cell.setAttribute('tabindex', '0');

                        cell.addEventListener('click', () => openEditWindow(index));
                    }
                });

                console.log(`Row ${index + 1} added`);
            });

            console.log('Displayed Data:', data);
        }

        function searchEquipment() {
            const serialNumberQuery = document.getElementById('serialNumber').value.toLowerCase().trim();
            const officeQuery = document.getElementById('office').value.toLowerCase().trim();
            const modalityQuery = document.getElementById('modality').value.toLowerCase().trim();
            const makeQuery = document.getElementById('make').value.toLowerCase().trim();
            const resultTable = document.getElementById('resultTable').getElementsByTagName('tbody')[0];

            console.log('Serial Number Query:', serialNumberQuery);
            console.log('Office Query:', officeQuery);
            console.log('Modality Query:', modalityQuery);
            console.log('Make Query:', makeQuery);

            resultTable.innerHTML = ''; // Clear previous results

            const filteredData = equipmentData.filter(item => {
                return (serialNumberQuery === '' || item['Serial Number'].toLowerCase().includes(serialNumberQuery)) &&
                       (officeQuery === '' || item['Office'].toLowerCase().includes(officeQuery)) &&
                       (modalityQuery === '' || item['Modality'].toLowerCase().includes(modalityQuery)) &&
                       (makeQuery === '' || item['Make'].toLowerCase().includes(makeQuery));
            });

            console.log('Filtered Data:', filteredData); // Log filtered data

            displayResults(filteredData); // Display filtered results
        }

        
        function openEditWindow(index) {
            const rowData = equipmentData[index];
            const headers = Object.keys(rowData);

            let editWindow = window.open('', '', 'width=600,height=800');
            editWindow.document.write('<html><head><title>Edit Row</title></head><body>');
            editWindow.document.write('<form id="editForm">');
            headers.forEach(header => {
                editWindow.document.write(`<label>${header}</label><br>`);
                editWindow.document.write(`<input type="text" name="${header}" value="${rowData[header]}" style="width:100%;"><br><br>`);
            });
            editWindow.document.write('<button type="button" onclick="window.opener.saveEditForm()">Save</button>');
            editWindow.document.write('</form>');
            editWindow.document.write('</body></html